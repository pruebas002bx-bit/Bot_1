<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chats Generales</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- ESTILOS (sin cambios, omitidos por brevedad) --- */
        :root {
            --left-panel-bg: #f0f2f5;
            --right-panel-header-bg: #e9edef;
            --chat-bg-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: #d1d8de;
            --accent-color: #00a884;
            --sent-bubble-bg: #d9fdd3;
            --received-bubble-bg: #ffffff;
            --danger-color: #ef4444;
            --success-color: #16a34a;
            --system-message-color: #4b5563; /* Color para mensajes del sistema */
            --avatar-colors: #b91c1c, #b45309, #a16207, #4d7c0f, #15803d, #0f766e, #1d4ed8, #6d28d9, #be185d;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .chat-container { width: 100vw; height: 100vh; display: flex; }
        .chat-list-panel { width: 30%; min-width: 350px; max-width: 450px; background: #ffffff; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .chat-list-header { padding: 10px 16px; background: var(--right-panel-header-bg); flex-shrink: 0; }
        .chat-search input { width: 100%; padding: 10px 15px; border-radius: 8px; border: none; background-color: #ffffff; }
        .chat-items { overflow-y: auto; flex-grow: 1; }
        .chat-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background-color 0.2s; border-bottom: 1px solid #f0f2f5; position: relative; }
        .chat-item:hover { background-color: #f5f6f6; }
        .chat-item.active { background-color: #e9edef; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.2em; flex-shrink: 0; }
        .chat-info { flex-grow: 1; overflow: hidden; }
        .chat-info .name { font-weight: 500; color: var(--text-primary); }
        .chat-info .last-message { font-size: 0.9em; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-meta { display: flex; flex-direction: column; align-items: flex-end; flex-shrink: 0; margin-left: 10px; }
        .chat-time { font-size: 0.8em; color: var(--text-secondary); }
        .unread-badge { background-color: var(--danger-color); color: white; font-size: 0.75em; font-weight: 600; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; margin-top: 5px; }
        .chat-tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-top: 10px; }
        .tab-btn { flex: 1; padding: 12px; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .chat-window-panel { width: 70%; display: flex; flex-direction: column; }
        .chat-window-header { padding: 10px 20px; background: var(--right-panel-header-bg); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .contact-info { display: flex; align-items: center; }
        .contact-info .avatar { width: 40px; height: 40px; font-size: 1em; }
        .contact-details { display: flex; flex-direction: column; margin-left: 15px; }
        .contact-details .name { font-weight: 500; }
        .contact-details .phone { font-size: 0.85em; color: var(--text-secondary); }
        .header-actions { position: relative; }
        .actions-menu-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.4em; padding: 5px 10px; cursor: pointer; border-radius: 50%; }
        .actions-menu-btn:hover { background-color: #d1d8de; }
        .actions-dropdown { display: none; position: absolute; background-color: white; min-width: 250px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.15); z-index: 10; right: 0; top: 40px; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; }
        .actions-dropdown.show { display: block; }
        .actions-dropdown a { color: var(--text-primary); padding: 12px 16px; text-decoration: none; display: flex; align-items: center; font-size: 0.9em; }
        .actions-dropdown a:hover { background-color: #f1f1f1; }
        .actions-dropdown a i { width: 30px; text-align: center; color: var(--text-secondary); }
        .actions-dropdown a.danger-action { color: var(--danger-color); }
        .message-area { flex-grow: 1; padding: 20px 8%; overflow-y: auto; display: flex; flex-direction: column; background-image: var(--chat-bg-image); }
        .message-bubble { max-width: 60%; padding: 8px 12px; border-radius: 8px; margin-bottom: 5px; line-height: 1.4; box-shadow: 0 1px 1px rgba(0,0,0,0.05); word-wrap: break-word; }
        .sent { background-color: var(--sent-bubble-bg); align-self: flex-end; }
        .received { background-color: var(--received-bubble-bg); align-self: flex-start; }
        /* --- INICIO CORRECCIÓN: Estilo para mensajes del sistema --- */
        .system { background-color: #e2e8f0; color: var(--system-message-color); font-size: 0.8em; align-self: center; padding: 4px 10px; margin-top: 5px; border-radius: 12px; font-style: italic; }
        /* --- FIN CORRECCIÓN --- */
        .message-input-area { padding: 10px 20px; background: var(--right-panel-header-bg); display: flex; align-items: center; }
        .message-input-area input { flex-grow: 1; padding: 12px 20px; border: none; border-radius: 24px; margin: 0 10px; }
        .message-input-area button { background: var(--accent-color); color: white; border: none; width: 48px; height: 48px; border-radius: 50%; font-size: 1.2em; cursor: pointer; transition: opacity 0.2s; }
        .message-input-area button:hover { opacity: 0.9; }
        .empty-chat-window { flex-grow: 1; display: flex; justify-content: center; align-items: center; text-align: center; color: var(--text-secondary); background: var(--right-panel-header-bg); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 5px 25px rgba(0,0,0,0.2); transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; margin-bottom: 15px; color: var(--text-primary); }
        .modal-content p { margin-bottom: 25px; color: var(--text-secondary); line-height: 1.6; }
        .modal-form-group { text-align: left; margin-bottom: 25px; }
        .modal-form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
        .modal-form-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; }
        .modal-actions { display: flex; justify-content: center; gap: 15px; }
        .modal-actions button { padding: 12px 25px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; min-width: 130px; }
        .btn-cancel { background-color: #e5e7eb; color: var(--text-secondary); }
        .btn-cancel:hover { background-color: #d1d5db; }
        .btn-confirm { color: white; }
        .btn-confirm.primary { background-color: var(--accent-color); }
        .btn-confirm.primary:hover { opacity: 0.9; }
        .success-icon { font-size: 4em; color: var(--success-color); margin-bottom: 20px; }

    </style>
</head>
<body>
    <div class="chat-container">
        <aside class="chat-list-panel">
            <header class="chat-list-header">
                <div class="chat-search"><input type="text" id="chat-search-input" placeholder="Buscar por número..."></div>
                <div class="chat-tabs">
                    <button class="tab-btn active" data-view="active">Activos</button>
                    </div>
            </header>
            <div class="chat-items" id="chat-list"></div>
        </aside>
        <main class="chat-window-panel" id="chat-window"></main>
    </div>

    <div class="modal-overlay" id="transfer-modal">
        <div class="modal-content">
            <h2>Transferir Chat</h2>
            <p>Selecciona el nuevo rol al que deseas asignar esta conversación.</p>
            <div class="modal-form-group">
                <label for="transfer-role-select">Transferir a:</label>
                <select id="transfer-role-select">
                    <option value="">Cargando roles...</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" id="transfer-cancel-btn">Cancelar</button>
                <button class="btn-confirm primary" id="transfer-confirm-btn">Confirmar</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="success-modal">
        <div class="modal-content">
            <div class="success-icon"><i class="fas fa-check-circle"></i></div>
            <h2>Éxito</h2>
            <p id="success-modal-message"></p>
            <div class="modal-actions">
                <button class="btn-confirm primary" id="success-modal-ok-btn">Aceptar</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let activeChatId = null;
    let allChats = [];
    let chatDataMap = new Map();
    let pollingInterval = null;
    const POLLING_RATE_MS = 2000; // Reducido a 2 segundos

    const chatListEl = document.getElementById('chat-list');
    const chatWindowEl = document.getElementById('chat-window');
    const successModalEl = document.getElementById('success-modal');
    const successModalOkBtn = document.getElementById('success-modal-ok-btn');
    const tabs = document.querySelectorAll('.tab-btn');
    const searchInput = document.getElementById('chat-search-input');
    const avatarColors = ['#b91c1c', '#b45309', '#a16207', '#4d7c0f', '#15803d', '#0f766e', '#1d4ed8', '#6d28d9', '#be185d'];

    // --- INICIO CORRECCIÓN: Elementos del Modal de Transferencia ---
    const transferModalEl = document.getElementById('transfer-modal');
    const transferRoleSelect = document.getElementById('transfer-role-select');
    const transferConfirmBtn = document.getElementById('transfer-confirm-btn');
    const transferCancelBtn = document.getElementById('transfer-cancel-btn');
    // --- FIN CORRECCIÓN ---

    const openSuccessModal = (message) => {
        document.getElementById('success-modal-message').textContent = message;
        successModalEl.classList.add('show');
    };
    const closeSuccessModal = () => successModalEl.classList.remove('show');
    successModalOkBtn.addEventListener('click', closeSuccessModal);

    const getAvatarDetails = (name, id) => {
        const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || '?';
        const color = avatarColors[id % avatarColors.length];
        return { initials, color };
    };

    const renderChatList = (filter = '') => {
        const filteredChats = allChats.filter(chat =>
            chat.name.toLowerCase().includes(filter.toLowerCase()) || chat.phone.includes(filter)
        );
        filteredChats.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

        chatListEl.innerHTML = '';
        if (filteredChats.length === 0) {
            chatListEl.innerHTML = '<p style="padding: 20px; text-align: center; color: #6b7280;">No hay chats activos asignados.</p>';
            return;
        }

        filteredChats.forEach(chat => {
            const { initials, color } = getAvatarDetails(chat.name, chat.id);
            const unreadBadge = chat.unread > 0 ? `<div class="unread-badge">${chat.unread}</div>` : '';
            const chatItem = document.createElement('div');
            chatItem.className = `chat-item ${chat.id === activeChatId ? 'active' : ''}`;
            chatItem.dataset.chatId = chat.id;
            chatItem.innerHTML = `
                <div class="avatar" style="background-color: ${color};">${initials}</div>
                <div class="chat-info"> <div class="name">${chat.name}</div> <div class="last-message">${chat.last_message}</div> </div>
                <div class="chat-meta"> <div class="chat-time">${chat.time}</div> ${unreadBadge} </div>`;
            chatListEl.appendChild(chatItem);
        });
    };

    const renderEmptyState = () => {
        chatWindowEl.innerHTML = `<div class="empty-chat-window"><div><i class="fas fa-comments" style="font-size: 5em; color: #dfe3e6;"></i><h2 style="margin-top: 20px;">Selecciona un chat para empezar</h2></div></div>`;
    };

    const fetchMessagesForChat = async (chatId) => {
        try {
            const response = await fetch(`/api/chats/${chatId}/messages`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const messages = await response.json();
            const messageArea = document.getElementById('message-area');
            if (!messageArea) return;

            // --- INICIO CORRECCIÓN: Renderizar mensajes del sistema ---
            messageArea.innerHTML = messages.map(msg => {
                let bubbleClass = '';
                if (msg.sender === 'agent') bubbleClass = 'sent';
                else if (msg.sender === 'user') bubbleClass = 'received';
                else if (msg.sender === 'system') bubbleClass = 'system'; // Nueva clase
                return `<div class="message-bubble ${bubbleClass}">${msg.text}</div>`;
            }).join('');
            // --- FIN CORRECCIÓN ---

            if (messageArea.scrollHeight - messageArea.scrollTop <= messageArea.clientHeight + 100) {
                messageArea.scrollTop = messageArea.scrollHeight;
            }
        } catch (error) {
            console.error('Error al cargar mensajes:', error);
            const messageArea = document.getElementById('message-area');
            if(messageArea) messageArea.innerHTML = '<p style="text-align:center; color: red;">Error al cargar mensajes.</p>';
        }
    };

    const renderChatWindow = (chatId) => {
        const chat = allChats.find(c => c.id === chatId);
        if (!chat) { renderEmptyState(); return; }
        const { initials, color } = getAvatarDetails(chat.name, chat.id);

        chatWindowEl.innerHTML = `
            <header class="chat-window-header">
                <div class="contact-info">
                    <div class="avatar" style="background-color: ${color};">${initials}</div>
                    <div class="contact-details"> <div class="name">${chat.name}</div> <div class="phone">${chat.phone}</div> </div>
                </div>
                <div class="header-actions">
                    <button class="actions-menu-btn" id="actions-menu-btn"><i class="fas fa-ellipsis-v"></i></button>
                    <div class="actions-dropdown" id="actions-dropdown">
                        <a href="#" data-action="archive"><i class="fas fa-archive"></i> Marcar como Resuelto</a>
                        <a href="#" data-action="transfer" class="danger-action"><i class="fas fa-random"></i> Transferir Chat</a>
                        </div>
                </div>
            </header>
            <div class="message-area" id="message-area"><p style="text-align:center; color: #6b7280;">Cargando mensajes...</p></div>
            <footer class="message-input-area">
                <form id="message-form" style="display: contents;">
                    <input type="text" id="message-input" placeholder="Escribe un mensaje aquí..." autocomplete="off">
                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                </form>
            </footer>`;
        fetchMessagesForChat(chatId);
    };

    const archiveActiveChat = async () => {
        // ... (código sin cambios)
        if (activeChatId === null) return;
        try {
            const response = await fetch(`/api/chats/${activeChatId}/resolve`, { method: 'POST' });
            if (!response.ok) throw new Error('No se pudo archivar el chat.');
            openSuccessModal('El chat ha sido marcado como resuelto.');
            activeChatId = null;
            await pollChats(true);
            renderEmptyState();
        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    };

    // --- INICIO CORRECCIÓN: Funciones para Transferencia ---
    const populateTransferModal = async () => {
        transferRoleSelect.innerHTML = '<option value="">Cargando roles...</option>';
        try {
            const response = await fetch('/api/bot_roles/list');
            if (!response.ok) throw new Error('Error al cargar roles');
            const roles = await response.json();

            // Filtrar el rol actual del chat si es posible
            const currentChat = chatDataMap.get(activeChatId);
            const currentRoleId = currentChat?.bot_role_id; // Necesitamos el ID del rol actual

            transferRoleSelect.innerHTML = '<option value="">-- Selecciona un rol --</option>';
            roles.forEach(role => {
                // No mostrar el rol actual en la lista de destino
                if (role.id !== currentRoleId) {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = role.title;
                    transferRoleSelect.appendChild(option);
                }
            });
            transferConfirmBtn.disabled = true; // Deshabilitar hasta que se seleccione algo

        } catch (error) {
            console.error(error);
            transferRoleSelect.innerHTML = '<option value="">Error al cargar</option>';
        }
    };

    transferRoleSelect.addEventListener('change', () => {
        transferConfirmBtn.disabled = !transferRoleSelect.value;
    });

    const openTransferModal = () => {
        if (activeChatId === null) return;
        populateTransferModal(); // Llenar el dropdown
        transferModalEl.classList.add('show');
    };

    const closeTransferModal = () => {
        transferModalEl.classList.remove('show');
    };

    const transferActiveChat = async () => {
        const targetRoleId = transferRoleSelect.value;
        if (!targetRoleId || activeChatId === null) return;

        transferConfirmBtn.disabled = true; // Evitar doble click
        transferConfirmBtn.textContent = 'Transfiriendo...';

        try {
            const response = await fetch(`/api/chats/${activeChatId}/transfer`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target_role_id: targetRoleId }),
            });

            if (!response.ok) {
                 const errorData = await response.json();
                 throw new Error(errorData.error || 'Error al transferir el chat.');
            }

            closeTransferModal();
            openSuccessModal('Chat transferido con éxito.');
            activeChatId = null;
            await pollChats(true); // Actualizar lista inmediatamente
            renderEmptyState();

        } catch (error) {
            console.error(error);
            alert(`Error: ${error.message}`);
        } finally {
             transferConfirmBtn.disabled = false;
             transferConfirmBtn.textContent = 'Confirmar';
        }
    };

    transferCancelBtn.addEventListener('click', closeTransferModal);
    transferConfirmBtn.addEventListener('click', transferActiveChat);
    // --- FIN CORRECCIÓN ---

    const pollChats = async (forceListUpdate = false) => {
        // ... (código sin cambios)
        try {
            const response = await fetch('/api/chats');
            if (!response.ok) {
                console.error('Error en polling:', response.status);
                return;
            }
            const latestChats = await response.json();
            let listNeedsUpdate = forceListUpdate;
            let activeChatNeedsUpdate = false;
            latestChats.forEach(newChatData => {
                const existingChatData = chatDataMap.get(newChatData.id);
                if (!existingChatData || newChatData.updated_at !== existingChatData.updated_at) {
                    chatDataMap.set(newChatData.id, newChatData);
                    if (newChatData.id === activeChatId) { activeChatNeedsUpdate = true; }
                    listNeedsUpdate = true;
                }
            });
            // Comprobar chats eliminados/resueltos/transferidos que ya no están en la lista del agente
            const latestChatIds = new Set(latestChats.map(c => c.id));
            let chatRemoved = false;
            for (const existingId of chatDataMap.keys()) {
                if (!latestChatIds.has(existingId)) {
                    chatDataMap.delete(existingId);
                    listNeedsUpdate = true;
                    if (existingId === activeChatId) { // Si el chat activo fue removido
                        activeChatId = null;
                        renderEmptyState(); // Limpiar ventana derecha
                        chatRemoved = true;
                    }
                }
            }
            if (chatRemoved) activeChatNeedsUpdate = false; // Ya no hay chat activo que actualizar

            allChats = latestChats; // Actualizar la lista local
            if (listNeedsUpdate) { renderChatList(searchInput.value.trim()); }
            if (activeChatNeedsUpdate) { fetchMessagesForChat(activeChatId); }

        } catch (error) {
            console.error('Error durante el polling:', error);
        }
    };

    const startPolling = () => {
        if (pollingInterval) clearInterval(pollingInterval);
        pollChats(true);
        pollingInterval = setInterval(pollChats, POLLING_RATE_MS);
    };
    const stopPolling = () => {
        if (pollingInterval) clearInterval(pollingInterval);
        pollingInterval = null;
    };

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            activeChatId = null;
            pollChats(true);
            renderEmptyState();
        });
    });

    searchInput.addEventListener('input', (e) => {
        renderChatList(e.target.value.trim());
    });

    chatListEl.addEventListener('click', (e) => {
        const chatItem = e.target.closest('.chat-item');
        if (chatItem) {
            const newActiveChatId = parseInt(chatItem.dataset.chatId);
            if (newActiveChatId === activeChatId) return;
            activeChatId = newActiveChatId;
            allChats.forEach(chat => { if(chat.id === activeChatId) chat.unread = 0; });
            renderChatList(searchInput.value.trim());
            renderChatWindow(activeChatId);
        }
    });

    chatWindowEl.addEventListener('click', (e) => {
        const menuBtn = e.target.closest('#actions-menu-btn');
        const dropdown = document.getElementById('actions-dropdown');
        if (menuBtn && dropdown) dropdown.classList.toggle('show');

        const actionLink = e.target.closest('a[data-action]');
        if (actionLink) {
            e.preventDefault();
            const action = actionLink.dataset.action;
            if (action === 'archive') archiveActiveChat();
            // --- INICIO CORRECCIÓN: Llamar a abrir modal de transferencia ---
            if (action === 'transfer') openTransferModal();
            // --- FIN CORRECCIÓN ---
            if (dropdown) dropdown.classList.remove('show');
        } else if (!e.target.closest('.header-actions')) {
            if (dropdown) dropdown.classList.remove('show');
        }
    });

    chatWindowEl.addEventListener('submit', async (e) => {
        // ... (código sin cambios)
        if (e.target.id === 'message-form') {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const messageText = input.value.trim();
            if (messageText && activeChatId !== null) {
                const messageArea = document.getElementById('message-area');
                const tempBubble = document.createElement('div');
                tempBubble.className = 'message-bubble sent';
                tempBubble.textContent = messageText;
                tempBubble.style.opacity = '0.7';
                messageArea.appendChild(tempBubble);
                messageArea.scrollTop = messageArea.scrollHeight;
                const messageToSend = input.value;
                input.value = '';
                try {
                    const response = await fetch(`/api/chats/${activeChatId}/messages`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: messageToSend }),
                    });
                    if (!response.ok) throw new Error('Error al enviar mensaje');
                    const result = await response.json();
                    tempBubble.textContent = result.message.text;
                    tempBubble.style.opacity = '1';
                    await pollChats(true); // Forzar actualización de lista
                } catch (error) {
                    console.error(error);
                    tempBubble.textContent += ' (Error al enviar)';
                    tempBubble.style.backgroundColor = '#fee2e2';
                    tempBubble.style.color = '#991b1b';
                    input.value = messageText;
                }
            }
        }
    });

    renderEmptyState();
    startPolling();
    window.addEventListener('beforeunload', stopPolling);
});
</script>
</body>
</html>